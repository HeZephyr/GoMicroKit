# GoMicroKit 系统架构

## 1. 架构概述
GoMicroKit 是一个轻量级微服务框架，旨在提供构建分布式系统所需的核心功能，同时保持简单性和灵活性。该框架采用分层架构设计，使各组件能够独立演化并通过明确定义的接口进行交互。

### 1.1 核心设计原则
- **简洁性**：提供简明直观的 API，降低学习曲线。
- **可扩展性**：基于接口设计，支持自定义实现和扩展。
- **模块化**：组件可独立使用，无紧耦合依赖。
- **可测试性**：设计便于单元测试和集成测试。
- **性能优先**：最小化运行时开销，优化关键路径。

### 1.2 系统层次结构
GoMicroKit 采用分层架构，包括以下主要层次：
```
┌─────────────────────────────────────────────────────────────┐
│                     应用层 (用户代码)                         │   
└───────────────────────────────┬─────────────────────────────┘
│
┌───────────────────────────────▼─────────────────────────────┐
│                     服务层 (Service)                         │
└───────────────────────────────┬─────────────────────────────┘
                                │
┌───────────────────────────────▼─────────────────────────────┐
│                     传输层 (Transport)                       │
└───────────────────────────────┬─────────────────────────────┘
                                │
┌───────┬───────────┬───────────┬───────────┬─────────────────┐
│       │           │           │           │
    ┌───▼───┐   ┌───▼───┐   ┌───▼───┐ ┌───▼───┐
    │注册中心│   │ 弹性模式│   │  日志 │ │   配置 │
    └───────┘   └───────┘   └───────┘ └───────┘
```
```
                 ┌──────────────────┐
                 │    客户端请求      │
                 └─────────┬────────┘
                           │
                           ▼
┌────────────────────────────────────────────────┐
│                   传输层                        │
│  ┌────────────┐  ┌────────────┐  ┌──────────┐  │
│  │请求解码/验证 │→ │中间件链处理  │→ │请求路由    │  │
│  └────────────┘  └────────────┘  └────┬─────┘  │
└────────────────────────────────────────┼───────┘
                           │
                           ▼
┌────────────────────────────────────────────────┐
│                   服务层                        │
│  ┌────────────┐  ┌────────────┐  ┌──────────┐  │
│  │弹性模式处理  │→ │端点处理函数  │→ │响应生成  │  │
│  └────────────┘  └────────────┘  └────┬─────┘  │
└────────────────────────────────────────┼───────┘
                           │
                           ▼
┌────────────────────────────────────────────────┐
│                   传输层                        │
│  ┌────────────┐  ┌────────────┐  ┌──────────┐  │
│  │响应编码      │← │中间件处理   │← │错误处理  │  │
│  └─────┬──────┘  └────────────┘  └──────────┘  │
└─────────┼──────────────────────────────────────┘
          │
          ▼
    ┌──────────────┐
    │ 响应返回客户端 │
    └──────────────┘
```

## 2. 核心组件

### 2.1 服务层 (Service)
服务层是 GoMicroKit 的核心，负责定义服务及其端点。

#### 2.1.1 主要接口
**Service 接口**：
```go
type Service interface {
    Name() string
    Version() string
    Metadata() map[string]string
    Endpoints() []Endpoint
}
```
**Endpoint 接口：**
```go
type Endpoint interface {
    Name() string
    Handler() any
    RequestType() reflect.Type
    ResponseType() reflect.Type
    Metadata() map[string]string
}
```

#### 2.1.2 工作流程
1. 用户定义服务和端点。
2. 服务注册到传输层。
3. 传输层接收请求并路由到相应端点。
4. 端点处理程序执行业务逻辑并返回响应。

### 2.2 传输层 (Transport)
传输层负责处理通信协议细节，包括请求/响应编解码和服务器实现。

#### 2.2.1 主要接口
**Transport 接口**：
```go
type Transport interface {
    Name() string
    Serve(addr string) error
    Stop(ctx context.Context) error
    Register(svc service.Service) error
}
```
**Codec 接口**：
```go
type Codec interface {
    ContentType() string
    Encode(ctx context.Context, w io.Writer, v any) error
    Decode(ctx context.Context, r io.Reader, v any) error
}
```

#### 2.2.2 支持的协议
- HTTP/REST (v0.1.0)
- gRPC (计划中)
- WebSocket (计划中)

### 2.3 注册中心 (Registry)
注册中心提供服务发现和注册功能，使微服务能够动态发现彼此。

#### 2.3.1 主要接口
**Registry 接口**：
```go
type Registry interface {
    Register(ctx context.Context, svc *ServiceInfo) error
    Deregister(ctx context.Context, svc *ServiceInfo) error
    GetService(ctx context.Context, name string) ([]*ServiceInfo, error)
    Watch(ctx context.Context, name string) (Watcher, error)
}
```

#### 2.3.2 支持的实现
- 内存注册中心 (v0.1.0)
- Consul (计划中)
- etcd (计划中)

### 2.4 弹性模式 (Resilience)
弹性模式组件提供容错和稳定性保障，如熔断器、限流器和重试机制。

#### 2.4.1 主要接口
**CircuitBreaker 接口**：
```go
type CircuitBreaker interface {
    Name() string
    Execute(ctx context.Context, fn func(ctx context.Context) (any, error)) (any, error)
    Allow() bool
    Success()
    Failure()
}
```
**RateLimiter 接口**：
```go
type RateLimiter interface {
    Name() string
    Allow() bool
    AllowN(n int) bool
}
```

### 2.5 日志 (Logging)
日志组件提供结构化日志记录功能，支持不同级别和上下文信息。

#### 2.5.1 主要接口
**Logger 接口**：
```go
type Logger interface {
    Debug(format string, args ...any)
    Info(format string, args ...any)
    Warn(format string, args ...any)
    Error(format string, args ...any)
    Fatal(format string, args ...any)
    WithField(key string, value any) Logger
    WithFields(fields map[string]any) Logger
}
```

## 3. 请求处理流程
下图展示了请求在 GoMicroKit 中的处理流程：
```
                 ┌──────────────────┐
                 │    客户端请求     │
                 └─────────┬────────┘
                           │
                           ▼
┌────────────────────────────────────────────────┐
│                   传输层                        │
│  ┌────────────┐  ┌────────────┐  ┌──────────┐  │
│  │请求解码/验证 │→ │中间件链处理 │→ │请求路由  │  │
│  └────────────┘  └────────────┘  └────┬─────┘  │
└────────────────────────────────────────┼───────┘
                           │
                           ▼
┌────────────────────────────────────────────────┐
│                   服务层                        │
│  ┌────────────┐  ┌────────────┐  ┌──────────┐  │
│  │弹性模式处理 │→ │端点处理函数 │→ │响应生成  │  │
│  └────────────┘  └────────────┘  └────┬─────┘  │
└────────────────────────────────────────┼───────┘
                           │
                           ▼
┌────────────────────────────────────────────────┐
│                   传输层                        │
│  ┌────────────┐  ┌────────────┐  ┌──────────┐  │
│  │响应编码    │← │中间件处理   │← │错误处理  │  │
│  └─────┬──────┘  └────────────┘  └──────────┘  │
└─────────┼──────────────────────────────────────┘
          │
          ▼
    ┌──────────────┐
    │ 响应返回客户端 │
    └──────────────┘
```

## 4. 中间件架构
中间件是 GoMicroKit 的重要扩展机制，允许在请求处理流程中添加横切关注点。

### 4.1 中间件接口
```go
type Middleware func(Handler) Handler

type Handler func(ctx context.Context, request any) (response any, err error)
```

### 4.2 中间件链
中间件以链式方式执行，每个中间件可以在调用下一个处理程序之前和之后执行逻辑：
```
Client → Middleware 1 → Middleware 2 → ... → Middleware N → Endpoint → Middleware N → ... → Middleware 2 → Middleware 1 → Client
```

### 4.3 常见中间件
- 日志中间件：记录请求/响应信息。
- 追踪中间件：添加分布式追踪。
- 恢复中间件：从 panic 中恢复。
- 验证中间件：验证请求参数。
- 限流中间件：应用请求限制。

## 5. 可扩展性设计
GoMicroKit 通过多种机制实现可扩展性：

### 5.1 接口抽象
所有核心组件都定义为接口，允许用户提供自定义实现。

### 5.2 适配器模式
框架使用适配器模式集成外部系统，如注册中心和追踪系统。

### 5.3 装饰器模式
中间件实现采用装饰器模式，允许动态组合和扩展功能。

## 6. 部署架构
GoMicroKit 支持多种部署模式：

### 6.1 单体服务
适用于开发和测试阶段，所有组件部署在同一进程中。
```
┌─────────────────────────────────────┐
│           单一进程/容器              │
│                                     │
│  ┌─────────┐  ┌─────────┐          │
│  │ 服务 A   │  │ 服务 B   │          │
│  └─────────┘  └─────────┘          │
│                                     │
│  ┌─────────────────────────────┐    │
│  │       GoMicroKit 框架        │    │
│  └─────────────────────────────┘    │
└─────────────────────────────────────┘
```

### 6.2 微服务部署
生产环境中的典型部署模式，每个服务独立部署。
```
┌─────────────┐  ┌─────────────┐  ┌─────────────┐
│   服务 A     │  │   服务 B     │  │   服务 C     │
│             │  │             │  │             │
│ ┌─────────┐ │  │ ┌─────────┐ │  │ ┌─────────┐ │
│ │GoMicroKit│ │  │ │GoMicroKit│ │  │ │GoMicroKit│ │
│ └─────────┘ │  │ └─────────┘ │  │ └─────────┘ │
└──────┬──────┘  └──────┬──────┘  └──────┬──────┘
       │                │                │
       └────────────────┼────────────────┘
                        │
              ┌─────────▼─────────┐
              │     注册中心       │
              │  (Consul/etcd)    │
              └───────────────────┘
``` 